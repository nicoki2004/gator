# gator

A small CLI tool to manage and read RSS/Atom feeds locally. gator provides commands to register/login users, add feeds, follow/unfollow feeds, list feeds, browse posts, and aggregate articles. It uses PostgreSQL (with queries generated by `sqlc`) for persistence and a simple JSON config file in the user's home directory.

## Features

- Register and login local users
- Add RSS feeds and follow/unfollow them
- List feeds and followed feeds
- Browse feed posts with optional limit
- Aggregate and fetch articles using a built-in RSS parser
- Store fetched articles in the database for offline browsing

## Prerequisites

To run **gator**, you'll need:

- **Go** (version 1.20 or later) — [Install Go](https://golang.org/doc/install)
- **PostgreSQL** (version 12+) — [Install PostgreSQL](https://www.postgresql.org/download/)

## Installation

The easiest way to install **gator** is using `go install`:

```sh
go install github.com/nicoki2004/gator@latest
```

This will build and install the `gator` binary to your `$GOPATH/bin` directory (usually `~/go/bin`). Make sure `$GOPATH/bin` is in your `$PATH`:

```sh
export PATH=$PATH:~/go/bin
```

Alternatively, clone and build from source:

```sh
git clone https://github.com/<your-user>/gator.git
cd gator
go build -o gator .
```

## Configuration

Before you can use gator, you need to set up the configuration file. gator reads configuration from `~/.gatorconfig.json` in your home directory.

Create `~/.gatorconfig.json` with the following structure:

```json
{
  "db_url": "postgres://user:password@localhost:5432/gator?sslmode=disable",
  "current_user_name": ""
}
```

Replace `user` and `password` with your PostgreSQL credentials. The `db_url` field tells gator how to connect to your database. The `current_user_name` field is automatically updated when you log in.

## Database Setup

First, create a PostgreSQL database:

```sh
createdb gator
```

Then apply the database schema (run all migration files in order):

```sh
psql -d gator -f sql/schema/001_users.sql
psql -d gator -f sql/schema/002_feeds.sql
psql -d gator -f sql/schema/003_feed_follows.sql
psql -d gator -f sql/schema/004_add_column_feeds.sql
psql -d gator -f sql/schema/005_posts.sql
```

Or run them all at once:

```sh
for f in sql/schema/*.sql; do psql -d gator -f "$f"; done
```

## Architecture

The project is a small CLI app written in Go. Key pieces:

- Command routing and handlers: top-level files such as `main.go` and `handler_*.go`
- Configuration: `internal/config/config.go` (uses `~/.gatorconfig.json`)
- Database models/queries: generated code in `internal/database` (sqlc)
- RSS fetching/parsing: `internal/rss/rss_feed.go`

## Usage

Once you've set up your config file and started the program, you can run commands. Here are the available commands:

### Authentication

- **`register <username>`** — Create a new user account
  ```sh
  gator register alice
  ```

- **`login <username>`** — Log in as a user (updates config file)
  ```sh
  gator login alice
  ```

- **`users`** — List all registered users
  ```sh
  gator users
  ```

### Feed Management

- **`addfeed <name> <url>`** — Add a new RSS feed (requires login)
  ```sh
  gator addfeed "Hacker News" https://news.ycombinator.com/rss
  ```

- **`feeds`** — List all available feeds
  ```sh
  gator feeds
  ```

- **`follow <url>`** — Follow a feed by URL (requires login)
  ```sh
  gator follow https://news.ycombinator.com/rss
  ```

- **`following`** — List feeds you're currently following (requires login)
  ```sh
  gator following
  ```

- **`unfollow <url>`** — Stop following a feed (requires login)
  ```sh
  gator unfollow https://news.ycombinator.com/rss
  ```

### Aggregation & Browsing

- **`agg <duration>`** — Fetch articles from all followed feeds at a specified interval (e.g., `1m`, `30s`)
  ```sh
  gator agg 1m
  ```
  This will continuously fetch new articles every minute. Press `Ctrl+C` to stop.

- **`browse [limit]`** — Browse articles from your followed feeds (default limit: 2 posts)
  ```sh
  gator browse        # Shows 2 most recent posts
  gator browse 10     # Shows 10 most recent posts
  ```

### Other

- **`reset`** — Delete all users and data from the database
  ```sh
  gator reset
  ```

### Quick Start Example

```sh
# Create a new user
gator register alice

# Log in as that user
gator login alice

# Add an RSS feed
gator addfeed "TechCrunch" https://techcrunch.com/feed/

# Follow the feed
gator follow https://techcrunch.com/feed/

# Start aggregating articles (run in background)
gator agg 5m &

# Browse articles you've fetched
gator browse 5
```

**Note:** Commands that modify user-specific data (like `addfeed`, `follow`, `unfollow`, `browse`) require you to be logged in first.

## Development notes

- RSS fetching/parsing: [internal/rss/rss_feed.go](internal/rss/rss_feed.go)
- Config management: [internal/config/config.go](internal/config/config.go)
- SQL schema: `sql/schema/*.sql`
- Generated DB models/queries: [internal/database](internal/database)
  - Users table: stores user accounts
  - Feeds table: stores RSS feeds added by users
  - FeedFollows table: tracks which users follow which feeds
  - Posts table: stores fetched articles from feeds

If you change SQL files, run `sqlc generate` to refresh `internal/database`.

## Contributing

Contributions are welcome. Open an issue or submit a pull request with changes and tests where appropriate.

## License

## Follow-ups

- Add unit and integration tests for handlers and database queries.
- Add CLI `--help` output and argument validation for all commands.
- Add support for Atom feeds and improved feed content parsing.
- Add caching and rate-limiting for feed fetching.

## Model Graph

Below is a simple Entity Relationship diagram (Mermaid) showing the primary models and relations used by the application.

```mermaid
erDiagram
		USERS ||--o{ FEEDS : owns
		USERS ||--o{ FEED_FOLLOWS : follows
		FEEDS ||--o{ FEED_FOLLOWS : followed_by
    FEEDS ||--o{ POSTS : contains
    USERS ||--o{ POSTS : "views via follows"

    USERS {
      uuid id PK
      timestamp created_at
      timestamp updated_at
      string name
    }
    FEEDS {
      uuid id PK
      timestamp created_at
      timestamp updated_at
      string name
      string url
      timestamp last_fetched_at
      uuid user_id FK
    }
    FEED_FOLLOWS {
      uuid id PK
      timestamp created_at
      timestamp updated_at
      uuid user_id FK
      uuid feed_id FK
    }
    POSTS {
      uuid id PK
      timestamp created_at
      timestamp updated_at
      string title
      string url
      string description
      timestamp published_at
      uuid feed_id FK
    }
```

- `User` — stores user metadata
- `Feed` — a feed added by a user, includes `last_fetched_at` for aggregation scheduling
- `FeedFollow` — join table linking users to feeds they follow
- `Post` — individual articles fetched from feeds, stored for offline browsing
